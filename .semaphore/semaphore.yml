version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Consumer Service
    task:
      jobs:
        - name: Build
          commands:
            - checkout
            - cd consumer-service
            - 'go get #Update dependencies'
            - go build -o consumer-service.bin
      epilogue:
        on_pass:
          commands:
            - artifact push workflow consumer-service.bin
  - name: 'Block #2'
    task:
      prologue:
        commands:
          - artifact pull workflow consumer-service.bin
      jobs:
        - name: Run
          commands:
            - chmod +x consumer-service.bin
            - ./consumer-service.bin &
            - sleep 5
            - 'curl -v http://localhost:${PORT}/'
      env_vars:
        - name: PORT
          value: '8080'
