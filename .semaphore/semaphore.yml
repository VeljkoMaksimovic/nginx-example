version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Consumer Service
    task:
      jobs:
        - name: Build
          commands:
            - checkout
            - cd consumer-service
            - cache restore go-$(checksum go.sum)
            - '#go get #Update dependencies'
            - '#cache store go-$(checksum go.sum) ${HOME}/go'
            - go build -o consumer-service.bin
      epilogue:
        on_pass:
          commands:
            - artifact push workflow consumer-service.bin
    dependencies: []
  - name: Run the service and curl it
    task:
      prologue:
        commands:
          - artifact pull workflow consumer-service.bin
      jobs:
        - name: Run
          commands:
            - chmod +x consumer-service.bin
            - ./consumer-service.bin &
            - sleep 5
            - 'curl -v http://localhost:${PORT}/'
      env_vars:
        - name: PORT
          value: '8080'
    dependencies:
      - Consumer Service
  - name: Kitchen Service
    dependencies: []
    task:
      epilogue:
        on_pass:
          commands:
            - artifact push workflow kitchen-service.bin
      jobs:
        - name: Build
          commands:
            - checkout
            - cd kitchen-service
            - 'go get #Update dependencies'
            - go build -o kitchen-service.bin
  - name: Run the kitchen service
    dependencies:
      - Kitchen Service
    task:
      env_vars:
        - name: PORT
          value: '8090'
      prologue:
        commands:
          - artifact pull workflow kitchen-service.bin
      jobs:
        - name: Run
          commands:
            - chmod +x kitchen-service.bin
            - ./kitchen-service.bin &
            - sleep 5
            - 'curl -v http://localhost:${PORT}/'
